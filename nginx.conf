# If Mattermost runs in this same compose, the container DNS name is "mattermost"
# If Mattermost runs elsewhere, change to that host/IP:port (e.g., 10.0.0.5:8065)
upstream mattermost_upstream {
    server mattermost:8065;
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain;  # replace with your domain or keep "_" for any host
    # server_name _;

    # If you plan to enable HTTPS later, you can redirect HTTP to HTTPS:
    # return 301 https://$host$request_uri;

    # WebSocket + reverse proxy 
    location / {
        proxy_http_version      1.1;
        proxy_set_header        Upgrade           $http_upgrade;
        proxy_set_header        Connection        "upgrade";
        proxy_set_header        Host              $http_host;
        proxy_set_header        X-Real-IP         $remote_addr;
        proxy_set_header        X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_set_header        X-Frame-Options   SAMEORIGIN;
        proxy_buffers           16 64k;
        proxy_buffer_size       128k;

        proxy_read_timeout      3600s;
        proxy_send_timeout      3600s;

        proxy_pass http://mattermost_upstream;
    }

    # (Optional) Static health check
    location = /nginx-health {
        return 200 'ok';
        add_header Content-Type text/plain;
    }
}
