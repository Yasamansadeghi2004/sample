version: "3.9"
services:
  thumbor:
    hostname: thumbor
    image: minimalcompact/thumbor:6.7.5
    volumes:
      - thumbor_data:/data
    environment:
      - THUMBOR_NUM_PROCESSES=2
      - CORS_ALLOW_ORIGIN=*
      - ALLOW_UNSAFE_URL=True
      - OPTIMIZERS=['thumbor.optimizers.gifv']
      - LOADER=thumbor.loaders.file_loader
      - FILE_LOADER_ROOT_PATH=/opt/
    healthcheck:
      test:  ["CMD", "curl", "-f", "http://localhost:80/healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
    ports:
      - 8000:80
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.hostname == ch-st-n1
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: '0.5'
          memory: 1g
    networks:
      - chabok

volumes:
  thumbor_data:
    driver: local
    driver_opts:
      type: none
      device: /mnt/gv0/thumbor
      o: bind

networks:
  chabok:
    name: chabok
    external: true
